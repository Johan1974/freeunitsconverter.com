let DOM={},activeCategory=null,SITE_URL_INT="http://frontend:80",SITE_URL_EXT="http://freeunitsconverter.com:8080/";function loadGoogleAnalytics(e){if(!e)return console.log("GA skipped: missing ID");var t=document.createElement("script"),t=(t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id="+e,document.head.appendChild(t),window.dataLayer=window.dataLayer||[],window.gtag=(...e)=>window.dataLayer.push(e),location.search.includes("debug_mode=true"));gtag("js",new Date),gtag("config",e,{debug_mode:t}),console.log("GA4 initialized",{id:e,debug_mode:t})}let $=e=>document.querySelector(e),$$=e=>Array.from(document.querySelectorAll(e)),formatNumber=e=>null!=e&&isFinite(e)?Math.abs(e)<1e-5?e.toExponential(4):(Math.round(1e6*e)/1e6).toString():"—",humanLabel=e=>e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),shortUnit=e=>e.replace(/_/g," "),buildPath=(window.CONVERTERS=[{id:"length",label:"Length",baseUnit:"meter",units:{millimeter:.001,centimeter:.01,meter:1,kilometer:1e3,inch:.0254,foot:.3048,yard:.9144,mile:1609.344}},{id:"weight",label:"Weight",baseUnit:"kilogram",units:{gram:.001,kilogram:1,pound:.45359237,ounce:.028349523125}},{id:"temperature",label:"Temperature",baseUnit:"celsius",type:"temperature",units:{celsius:{toBase:e=>e,fromBase:e=>e,label:"°C"},fahrenheit:{toBase:e=>5/9*(e-32),fromBase:e=>1.8*e+32,label:"°F"},kelvin:{toBase:e=>e-273.15,fromBase:e=>e+273.15,label:"K"}}},{id:"volume",label:"Volume",baseUnit:"liter",units:{milliliter:.001,liter:1,cubic_meter:1e3,gallon_us:3.78541,gallon_imperial:4.54609,cup_us:.236588}}],(...e)=>e.map(e=>e.replace(/^\/+|\/+$/g,"")).join("/"));async function loadConversionGuide(t,o,a){if(DOM.guideContentEl){var r=SITE_URL_EXT.replace(/\/+$/,""),e=o+"-to-"+a,a=a+"-to-"+o,o=buildPath(r,"static-pages",t,e,"conversionguide.html");try{var i=await fetch(o,{cache:"no-store"});if(!i.ok)throw new Error("Failed to load forward conversion guide");var n=await i.text();if(console.log("Fetched HTML for forward path:",n),n.includes("<html"))throw new Error("Invalid HTML content");DOM.guideContentEl.innerHTML=n,console.log("Inserted HTML for forward path:",n)}catch(e){console.log("Error with forward path:",e),o=buildPath(r,"static-pages",t,a,"conversionguide.html");try{var l=await fetch(o,{cache:"no-store"});if(!l.ok)throw new Error("Failed to load reverse conversion guide");var s=await l.text();if(console.log("Fetched HTML for reverse path:",s),s.includes("<html"))throw new Error("Invalid HTML content for reverse");DOM.guideContentEl.innerHTML=s,console.log("Inserted HTML for reverse path:",s)}catch(e){console.log("Error with reverse path:",e);try{var c=await(await fetch(buildPath(r,"conversionguide-default.html"),{cache:"no-store"})).text();console.log("Fetched default HTML:",c),DOM.guideContentEl.innerHTML=c}catch(e){console.log("Error loading default guide:",e),DOM.guideContentEl.innerHTML="<p>Conversion guide is not available at the moment.</p>"}}}}}function showResult(e,t=!0){DOM.resultBox&&(DOM.resultBox.style.display="block",DOM.resultBox.textContent=e,DOM.resultBox.style.color=t?"var(--text)":"red",DOM.resultBox.style.background=t?"#f9f9f9":"#fee")}function pushHistory(e){var t=JSON.parse(localStorage.getItem("history")||"[]");t.unshift(e),localStorage.setItem("history",JSON.stringify(t.slice(0,5))),renderHistory()}function renderHistory(){if(DOM.historyList){let o=JSON.parse(localStorage.getItem("history")||"[]");DOM.historyList.innerHTML=o.map((e,t)=>`
    <div class="item-row">
      <span>${formatNumber(e.value)} ${shortUnit(e.from)} → ${formatNumber(e.out)} ${shortUnit(e.to)}</span>
      <button class="remove-btn" data-index="${t}" aria-label="Remove item">&times;</button>
    </div>
  `).join(""),DOM.historyList.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",e=>{var t=Number(e.target.dataset.index);o.splice(t,1),localStorage.setItem("history",JSON.stringify(o)),renderHistory(),e.stopPropagation()})})}}function saveFavorite(){var e,t,o,a,r,i;return activeCategory?(e=window.CONVERTERS.find(e=>e.id===activeCategory),t=DOM.fromSelect.value,o=DOM.toSelect.value,a=Number(DOM.valueInput.value.trim().replace(",","."))||NaN,Number.isNaN(a)?showResult("Invalid value",!1):(r="temperature"===e.type?e.units[o].fromBase(e.units[t].toBase(a)):a*e.units[t]/e.units[o],(i=JSON.parse(localStorage.getItem("favorites")||"[]")).unshift({cat:e.id,from:t,to:o,value:a,out:r,ts:Date.now()}),localStorage.setItem("favorites",JSON.stringify(i.slice(0,50))),renderFavorites(),void showResult("Saved as favorite!"))):showResult("Select a category first",!1)}function renderFavorites(){if(DOM.favList){let o=JSON.parse(localStorage.getItem("favorites")||"[]");DOM.favList.innerHTML=o.map((e,t)=>`
    <div class="item-row">
      <span>${formatNumber(e.value)} ${shortUnit(e.from)} → ${formatNumber(e.out)} ${shortUnit(e.to)}</span>
      <button class="remove-btn" data-index="${t}" aria-label="Remove favorite">&times;</button>
    </div>
  `).join(""),DOM.favList.querySelectorAll(".remove-btn").forEach(e=>{e.addEventListener("click",e=>{var t=Number(e.target.dataset.index);o.splice(t,1),localStorage.setItem("favorites",JSON.stringify(o)),renderFavorites(),e.stopPropagation()})})}}function convert(){if(activeCategory){var o=window.CONVERTERS.find(e=>e.id===activeCategory),a=DOM.valueInput.value.trim();if(a){a=Number(a.replace(",","."));if(Number.isNaN(a))showResult("Invalid value",!1);else{var r,i=DOM.fromSelect.value,n=DOM.toSelect.value;let e,t;showResult(t="temperature"===o.type?(r=o.units[i].toBase(a),e=o.units[n].fromBase(r),`${formatNumber(a)} ${o.units[i].label||""} = ${formatNumber(e)} `+(o.units[n].label||"")):(e=a*o.units[i]/o.units[n],`${formatNumber(a)} ${shortUnit(i)} = ${formatNumber(e)} `+shortUnit(n)),!0),pushHistory({cat:o.id,from:i,to:n,value:a,out:e,ts:Date.now()}),loadConversionGuide(o.id,i,n),"function"==typeof gtag&&gtag("event","unit_combo",{unit_combo:i+"→"+n,debug_mode:location.search.includes("debug_mode=true")})}}else showResult("Enter a value",!1)}else showResult("Select a category first",!1)}function swapUnits(){var e=DOM.fromSelect.selectedIndex;DOM.fromSelect.selectedIndex=DOM.toSelect.selectedIndex,DOM.toSelect.selectedIndex=e,convert()}function populateUnitSelects(e,t=null,o=null){DOM.fromSelect.innerHTML=DOM.toSelect.innerHTML="",Object.entries(e.units).forEach(([e,t])=>{t=t.label?e+" "+t.label:e;DOM.fromSelect.add(new Option(t,e)),DOM.toSelect.add(new Option(t,e))}),t&&(DOM.fromSelect.value=t),o&&(DOM.toSelect.value=o),t||(DOM.fromSelect.selectedIndex=0),o||(DOM.toSelect.selectedIndex=1)}function renderTabs(){DOM.tabsEl.innerHTML=DOM.categoryLinksEl.innerHTML="",window.CONVERTERS.forEach(o=>{[DOM.tabsEl,DOM.categoryLinksEl].forEach(e=>{var t=document.createElement("button");t.className="tab"+(o.id===activeCategory?" active":""),t.textContent=o.label,t.dataset.route="/"+o.id,e.appendChild(t),e.addEventListener("click",e=>{e=e.target.closest("button[data-route]");e&&setActiveCategory(e.dataset.route.slice(1))})})})}function setActiveCategory(t){var e;t&&(e=window.CONVERTERS.find(e=>e.id===t)||window.CONVERTERS[0],activeCategory=e.id,$$(".tab").forEach(e=>e.classList.remove("active")),$$(`.tab[data-route='/${e.id}']`).forEach(e=>e.classList.add("active")),populateUnitSelects(e),DOM.resultBox&&(DOM.resultBox.style.display="none"),loadConversionGuide(e.id,DOM.fromSelect.value,DOM.toSelect.value))}function handleURLUnitCombo(){var o=location.pathname.replace(/^\/|\/$/g,"").split("/");if(2===o.length){let[t,e]=o;var a,r,o=e.split("-to-");2===o.length&&([o,a]=o,r=window.CONVERTERS.find(e=>e.id===t))&&r.units[o]&&r.units[a]&&(setActiveCategory(t),DOM.fromSelect.value=o,DOM.toSelect.value=a,loadConversionGuide(t,o,a),convert(),history.replaceState(null,"","/"))}}function bindUI(){DOM.convertBtn.addEventListener("click",convert),DOM.swapBtn.addEventListener("click",swapUnits),DOM.saveFavBtn.addEventListener("click",saveFavorite),DOM.fromSelect.addEventListener("change",()=>{loadConversionGuide(window.CONVERTERS.find(e=>e.id===activeCategory).id,DOM.fromSelect.value,DOM.toSelect.value)}),DOM.toSelect.addEventListener("change",()=>{loadConversionGuide(window.CONVERTERS.find(e=>e.id===activeCategory).id,DOM.fromSelect.value,DOM.toSelect.value)}),$("#clearFavoritesBtn")?.addEventListener("click",()=>{confirm("Clear all favorites?")&&(localStorage.removeItem("favorites"),renderFavorites(),showResult("All favorites cleared"))}),$("#clearHistoryBtn")?.addEventListener("click",()=>{confirm("Clear recent history?")&&(localStorage.removeItem("history"),renderHistory(),showResult("Recent history cleared"))})}function init(){DOM.yearEl.textContent=(new Date).getFullYear(),bindUI(),renderTabs(),handleURLUnitCombo(),activeCategory||setActiveCategory(window.CONVERTERS[0].id),renderHistory(),renderFavorites(),loadGoogleAnalytics("G-HX0YW2Z8WS")}document.addEventListener("DOMContentLoaded",()=>{DOM.tabsEl=$("#categoryTabs"),DOM.categoryLinksEl=$("#categoryLinks"),DOM.fromSelect=$("#fromSelect"),DOM.toSelect=$("#toSelect"),DOM.valueInput=$("#valueInput"),DOM.resultBox=$("#resultBox"),DOM.guideContentEl=$("#guideContent"),DOM.historyList=$("#historyList"),DOM.favList=$("#favList"),DOM.convertBtn=$("#convertBtn"),DOM.swapBtn=$("#swapBtn"),DOM.saveFavBtn=$("#saveFavBtn"),DOM.yearEl=$("#year"),init()});