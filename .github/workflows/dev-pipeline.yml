name: Development CI Pipeline

# Trigger the workflow on pushes to development branch
on:
  push:
    branches:
      - development

jobs:
  build-and-seo:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Docker Buildx for building containers
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Build frontend container (dev mode)
      - name: Build frontend container
        run: |
          docker build -f frontend/Dockerfile.dev -t freeunitsconverter_dev-frontend ./frontend

      # Step 4: Build backend container
      - name: Build backend container
        run: |
          docker build -f backend/Dockerfile -t freeunitsconverter_dev-backend ./backend

      # Step 5: Build SEO audit container
      - name: Build SEO audit container
        run: |
          docker build -f seo_audit/Dockerfile.dev -t freeunitsconverter_dev-seo_audit ./seo_audit

      # Step 6: Generate static pages and sitemap
      - name: Generate static pages
        run: |
          docker run --rm -v $GITHUB_WORKSPACE/frontend:/app -w /app node:18 node generate-pages.js
          docker run --rm -v $GITHUB_WORKSPACE/frontend:/app -w /app node:18 node generate-sitemap.js

      # Step 7: Run SEO audit container
      - name: Run SEO audit
        run: |
          docker run --rm \
            -e SITE_URL=http://localhost:8080 \
            -v $GITHUB_WORKSPACE/frontend/static-pages:/usr/src/app/static-pages:ro \
            freeunitsconverter_dev-seo_audit

      # Step 8: Upload SEO report for inspection
      - name: Upload SEO audit report
        uses: actions/upload-artifact@v3
        with:
          name: seo-report
          path: seo_audit/reports/
